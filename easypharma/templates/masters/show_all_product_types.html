{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Product Types</title>
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <style>
        .d-none { display: none; }
    </style>
</head>
<body>

<div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar bg-light p-3" style="width: 250px; min-height: 100vh;">
        {% include 'includes/sidebar.html' %}
    </div>

    <!-- Main Content -->
    <div class="content flex-grow-1 p-4">
        <h2>Add Product Type</h2>

        <form method="POST" class="mb-5">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="productTypeName" class="form-label">Name</label>
                    <input type="text" class="form-control" id="productTypeName" name="name" placeholder="Tablet" required>
                </div>
            </div>
            <button type="submit" class="btn btn-success">Save</button>
        </form>

        <h2 class="text-primary">All Product Types</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Sr No.</th>
                    <th>Name</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for product_type in product_types %}
                <tr id="row-{{ product_type.id }}">
                    <td>{{ forloop.counter }}</td>
                    <td>
                        <span id="name-display-{{ product_type.id }}">{{ product_type.name }}</span>
                        <input type="text" id="name-input-{{ product_type.id }}" value="{{ product_type.name }}" class="form-control d-none">
                    </td>
                    <td>
                        <button type="button" onclick="enableEdit({{ product_type.id }})" id="edit-btn-{{ product_type.id }}" class="btn btn-sm btn-primary">Edit</button>
                        <button type="button" onclick="saveEdit({{ product_type.id }})" id="save-btn-{{ product_type.id }}" class="btn btn-sm btn-success d-none">Save</button>
                        <button type="button" onclick="deleteProductType({{ product_type.id }})" class="btn btn-sm btn-danger">Delete</button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3">No product types found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// ✅ Helper to get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ✅ Enable inline edit
function enableEdit(id) {
    document.getElementById(`name-display-${id}`).classList.add("d-none");
    document.getElementById(`name-input-${id}`).classList.remove("d-none");
    document.getElementById(`edit-btn-${id}`).classList.add("d-none");
    document.getElementById(`save-btn-${id}`).classList.remove("d-none");
}

// ✅ Save edited name (PATCH)
function saveEdit(id) {
    const newName = document.getElementById(`name-input-${id}`).value;

    fetch("/master/show-all-product-types/", {
        method: "PATCH",
        headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ id: id, name: newName }),
    })
    .then(response => {
        if (!response.ok) throw new Error("HTTP error " + response.status);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert(data.success);
            document.getElementById(`name-display-${id}`).textContent = newName;
            document.getElementById(`name-display-${id}`).classList.remove("d-none");
            document.getElementById(`name-input-${id}`).classList.add("d-none");
            document.getElementById(`edit-btn-${id}`).classList.remove("d-none");
            document.getElementById(`save-btn-${id}`).classList.add("d-none");
        } else {
            alert("Error: " + data.error);
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Something went wrong while updating!");
    });
}

// ✅ Delete product type (DELETE)
function deleteProductType(id) {
    if (!confirm("Are you sure you want to delete this product type?")) return;

    fetch("/master/show-all-product-types/", {
        method: "DELETE",
        headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ id: id }),
    })
    .then(response => {
        if (!response.ok) throw new Error("HTTP error " + response.status);
        return response.json();
    })
    .then(data => {
        if (data.success) {
            alert("Product type deleted successfully.");
            document.getElementById(`row-${id}`).remove();
        } else {
            alert("Error: " + data.error);
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Something went wrong!");
    });
}
</script>

</body>
</html>
