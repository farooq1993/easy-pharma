{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Create Product</title>
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <!-- Add to head -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <style>
        .d-none { display: none; }
        .select2-container--default .select2-selection--single {
            height: 38px;
            padding: 5px;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
        }
        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 36px;
        }
    </style>
</head>
<body>

<div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar bg-light p-3" style="width: 250px; min-height: 100vh;">
        {% include 'includes/sidebar.html' %}
    </div>

    <!-- Main Content -->
    <div class="content flex-grow-1 p-4">
        <h2>Add Product</h2>
        {% include 'includes/messages.html' %}
        
        <form method="POST" class="mb-5">
            {% csrf_token %}
            <div class="row">
                <!-- Product Name -->
                <div class="col-md-6 mb-3">
                    <label for="productName" class="form-label">Product Name *</label>
                    <input type="text" class="form-control" id="productName" name="product_name" placeholder="Enter product name" required>
                </div>

                <!-- Product Packing -->
                <div class="col-md-6 mb-3">
                    <label for="productPacking" class="form-label">Product Packing</label>
                    <input type="text" class="form-control" id="productPacking" name="product_packing" placeholder="e.g., 10 tablets, 100ml bottle">
                </div>

                <!-- Product Type -->
                <div class="col-md-6 mb-3">
                    <label for="productType" class="form-label">Product Type</label>
                    <select class="form-select" id="productType" name="product_type">
                        <option value="">Select Product Type</option>
                        {% for product_type in product_types %}
                            <option value="{{ product_type.id }}">{{ product_type.name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Product Schedule -->
                <div class="col-md-6 mb-3">
                    <label for="productSchedule" class="form-label">Product Schedule</label>
                    <select class="form-select" id="productSchedule" name="product_schedule">
                        <option value="">Select Product Schedule</option>
                        {% for schedule in product_schedules %}
                            <option value="{{ schedule.id }}">{{ schedule.schedule_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Product Tax -->
                <div class="col-md-6 mb-3">
                    <label for="productTax" class="form-label">Product Tax</label>
                    <select class="form-select" id="productTax" name="product_tax">
                        <option value="">Select Product Tax</option>
                        {% for tax in product_taxes %}
                            <option value="{{ tax.id }}">{{ tax.tax_name }} ({{ tax.tax_rate }}%)</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- HSN Code -->
                <div class="col-md-6 mb-3">
                    <label for="productHsnCode" class="form-label">HSN Code *</label>
                    <input type="text" class="form-control" id="productHsnCode" name="product_hsn_code" placeholder="Enter HSN code" required>
                </div>

                <!-- Product Content -->
                <div class="col-md-6 mb-3">
                    <label for="productContent" class="form-label">Product Content</label>
                    <select class="form-select" id="productContent" name="product_content">
                        <option value="">Select Product Content</option>
                        {% for content in product_contents %}
                            <option value="{{ content.id }}">{{ content.content_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-6 mb-3">
                    <label for="productContent" class="form-label">Product Company</label>
                    <select class="form-select" id="productContent" name="compny_name">
                        <option value="">Select Product Company</option>
                        {% for company in compny_name %}
                            <option value="{{ company.id }}">{{ company.company_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <button type="submit" class="btn btn-success">Save Product</button>
            <button type="reset" class="btn btn-secondary">Reset</button>
        </form>

        <h2 class="text-primary">All Products</h2>
        <table class="table table-striped">
            <thead class="table-dark">
                <tr>
                    <th>Sr No.</th>
                    <th>Product Name</th>
                    <th>Packing</th>
                    <th>Type</th>
                    <th>Schedule</th>
                    <th>HSN Code</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr id="row-{{ product.id }}">
                    <td>{{ forloop.counter }}</td>
                    <td>{{ product.product_name }}</td>
                    <td>{{ product.product_packing|default:"-" }}</td>
                    <td>{{ product.product_type.name|default:"-" }}</td>
                    <td>{{ product.product_schedule.schedule_name|default:"-" }}</td>
                    <td>{{ product.product_hsn_code }}</td>
                    <td>
                        <button type="button" onclick="enableEdit({{ product.id }})" class="btn btn-sm btn-primary">Edit</button>
                        <button type="button" onclick="deleteProduct({{ product.id }})" class="btn btn-sm btn-danger">Delete</button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center">No products found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
<!-- Add before closing </body> -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>


<script>
// ✅ Helper to get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ✅ Delete product
function deleteProduct(id) {
    if (!confirm("Are you sure you want to delete this product?")) return;

    fetch("/master/products/", {
        method: "DELETE",
        headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "Content-Type": "application/json",
        },
        body: JSON.stringify({ id: id }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert("Product deleted successfully.");
            document.getElementById(`row-${id}`).remove();
        } else {
            alert("Error: " + (data.error || "Unable to delete"));
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Error: " + error.message);
    });
}

// ✅ Simple edit redirect (you can enhance this with inline editing later)
function enableEdit(id) {
    if (confirm("Edit product? This will redirect to edit page.")) {
        window.location.href = `/master/products/edit/${id}/`;
    }
}
</script>

</body>
</html>