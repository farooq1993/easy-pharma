{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Drug Schedule Types</title>
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <style>
        .d-none { display: none; }
    </style>
</head>
<body>

<div class="d-flex">
    <!-- Sidebar -->
    <div class="sidebar bg-light p-3" style="width: 250px; min-height: 100vh;">
        {% include 'includes/sidebar.html' %}
    </div>

    <!-- Main Content -->
    <div class="content flex-grow-1 p-4">
        <h2>Add Product</h2>
            {% include 'includes/messages.html' %}
        <form method="POST" class="mb-5">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="drugScheduleName" class="form-label">Name</label>
                    <input type="text" class="form-control" id="drugScheduleName" name="schedule_name" placeholder="Schedule H Drug" required>
                </div>
            </div>
            <button type="submit" class="btn btn-success">Save</button>
        </form>

        <h2 class="text-primary">All Product List</h2>
        <table class="table">
            <thead>
                <tr>
                    <th>Sr No.</th>
                    <th>Name</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for schedule in drug_schedules %}
                <tr id="row-{{ schedule.id }}">
                    <td>{{ forloop.counter }}</td>
                    <td>
                        <span id="name-display-{{ schedule.id }}">{{ schedule.schedule_name }}</span>
                        <input type="text" id="name-input-{{ schedule.id }}" value="{{ schedule.schedule_name }}" class="form-control d-none">
                    </td>
                    <td>
                        <button type="button" onclick="enableEdit({{ schedule.id }})" id="edit-btn-{{ schedule.id }}" class="btn btn-sm btn-primary">Edit</button>
                        <button type="button" onclick="saveEdit({{ schedule.id }})" id="save-btn-{{ schedule.id }}" class="btn btn-sm btn-success d-none">Save</button>
                        <button type="button" onclick="deleteDrugSchedule({{ schedule.id }})" class="btn btn-sm btn-danger">Delete</button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3">No drug schedules found.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
// ✅ Helper to get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + "=")) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// ✅ Enable inline edit
function enableEdit(id) {
    document.getElementById(`name-display-${id}`).classList.add("d-none");
    document.getElementById(`name-input-${id}`).classList.remove("d-none");
    document.getElementById(`edit-btn-${id}`).classList.add("d-none");
    document.getElementById(`save-btn-${id}`).classList.remove("d-none");
}

// ✅ Save edited name (PATCH)
function saveEdit(id) {
    const newName = document.getElementById(`name-input-${id}`).value.trim();
    
    if (!newName) {
        alert("Please enter a valid name");
        return;
    }

    console.log("Sending PATCH request for ID:", id, "New name:", newName);

    fetch("/master/show-all-drug-schedule-types/", {
        method: "PATCH",
        headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest", // Add this header
        },
        body: JSON.stringify({ 
            id: id, 
            schedule_name: newName // Changed from 'name' to 'schedule_name'
        }),
    })
    .then(response => {
        console.log("Response status:", response.status);
        
        // Check if response is JSON
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.includes("application/json")) {
            return response.json().then(data => {
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error ${response.status}`);
                }
                return data;
            });
        } else {
            return response.text().then(text => {
                throw new Error(`Server returned: ${text.substring(0, 100)}`);
            });
        }
    })
    .then(data => {
        console.log("Success data:", data);
        if (data.success) {
            alert(data.success);
            document.getElementById(`name-display-${id}`).textContent = newName;
            document.getElementById(`name-display-${id}`).classList.remove("d-none");
            document.getElementById(`name-input-${id}`).classList.add("d-none");
            document.getElementById(`edit-btn-${id}`).classList.remove("d-none");
            document.getElementById(`save-btn-${id}`).classList.add("d-none");
        } else {
            alert("Error: " + (data.error || "Unknown error"));
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Error: " + error.message);
    });
}

// ✅ Delete drug schedule (DELETE)
function deleteDrugSchedule(id) {
    if (!confirm("Are you sure you want to delete this drug schedule?")) return;

    console.log("Sending DELETE request for ID:", id);

    fetch("/master/show-all-drug-schedule-types/", {
        method: "DELETE",
        headers: {
            "X-CSRFToken": getCookie("csrftoken"),
            "Content-Type": "application/json",
            "X-Requested-With": "XMLHttpRequest", // Add this header
        },
        body: JSON.stringify({ id: id }),
    })
    .then(response => {
        console.log("Response status:", response.status);
        
        // Check if response is JSON
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.includes("application/json")) {
            return response.json().then(data => {
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error ${response.status}`);
                }
                return data;
            });
        } else {
            return response.text().then(text => {
                throw new Error(`Server returned: ${text.substring(0, 100)}`);
            });
        }
    })
    .then(data => {
        console.log("Success data:", data);
        if (data.success) {
            alert("Drug schedule deleted successfully.");
            document.getElementById(`row-${id}`).remove();
        } else {
            alert("Error: " + (data.error || "Unable to delete"));
        }
    })
    .catch(error => {
        console.error("Error:", error);
        alert("Error: " + error.message);
    });
}
</script>

</body>
</html>